
# MASTER PROMPT (RU)

Создать Python‑проект, который обрабатывает ежемесячные отчёты Interactive Brokers (MTM Summary CSV) и формирует годовой отчёт в JSON и PDF.

---

## Основные задачи

1. **Входные данные**
   - Один или несколько CSV‑отчётов IBKR MTM Summary из любого периода.

2. **Выходные данные**
   - Объединённый **JSON** за выбранный год.
   - **PDF‑отчёт**, включающий:
     - Итоговый свод по тикерам и валютам
     - Помесячный свод
     - Свод активов (Assets Summary)
     - Итоговый налоговый раздел (включая польский налог 19% и зачет удержанного)
     - Чек‑лист для формы **PIT‑38** (как использовать данные отчёта)
     - *Курсы валют в PDF больше не выводятся*, но сохраняются в JSON.

---

## Парсинг CSV

- Файл может содержать BOM → нужно удалять перед разбором.
- Период отчёта берётся из строки вида:
  ```
  Statement,Data,Period,"January 1, 2025 - January 31, 2025"
  ```
- Необходимо извлечь:
  - `fromDate = 2025-01-01`
  - `toDate = 2025-01-31`
  - `year = 2025` (используем правую дату для определения года)
- Названия месяцев английские → преобразование в ISO формат (`YYYY-MM-DD`).

---

## Обработка дивидендов

Формат строки:
```
Dividends,Data,<CURRENCY>,<DATE>,<DESCRIPTION>,<AMOUNT>
```

- Тикер извлекается из начала описания:
  `AGR(US05351W1036) Cash Dividend ... → AGR`

- Конвертация суммы в PLN выполняется по курсу NBP на дату.

- Сохраняем запись в JSON:
```json
{
  "ticker": "AGR",
  "currency": "USD",
  "date": "2025-01-02",
  "amount": 4.4,
  "amountPln": 18.04
}
```

- Строки с годом, отличным от года отчёта, **игнорируются**.

---

## Обработка удержанного налога (Withholding Tax)

Строки вида:
```
Withholding Tax,Data,<CURRENCY>,<DATE>,<DESCRIPTION>,<AMOUNT>
```

- Извлекаем тикер аналогичным способом.
- Значение может быть отрицательным → знак **не меняем**.
- Конвертируем в PLN по курсу NBP.

---

## Курсы валют (NBP) и JSON структура

Курсы загружаются через API NBP:
```
https://api.nbp.pl/api/exchangerates/rates/a/<CURRENCY>/<FROM>/<TO>?format=json
```

- Если валюта **PLN** → курс = `1.0`.
- Курсы кэшируются локально (`cache/nbp/`).

### Формат в JSON:
```json
"fx": {
  "USD": [
    {"date": "2025-01-02", "rate": 4.10},
    {"date": "2025-01-03", "rate": 4.12}
  ]
}
```

---

## Округление (money())

Используется **банковское округление (half-even)** до 2 знаков.

```
2.345 → 2.34
2.355 → 2.36
```

---

## Итоговый JSON

```json
{
  "years": [
    {
      "year": "2025",
      "fromDate": "2025-01-01",
      "toDate": "2025-12-31",
      "dividends": [...],
      "taxes": [...],
      "fx": {...},
      "monthly_dividends": [...],
      "monthly_taxes": [...],
      "year_dividends": [...],
      "year_taxes": [...]
    }
  ]
}
```

---

## PDF‑отчёт (reportlab)

Содержит страницы (в указанном порядке):

1. **Cover page** — год и период
2. **Assets Summary** (многостраничная таблица)
3. **Monthly Summary**
4. **Yearly Summary**:
   - Total Dividends PLN
   - Total Tax PLN
   - Additional PL Tax @ 9%
   - Final Net @ 19%
   - Diagnostics (tickers, rows count)
   - Per‑currency totals
5. **PIT‑38 Helper Page** — таблицы для переноса в налоговую форму

Таблицы автоматически переносятся между страницами.

---

## Тестирование (pytest)

Обязательно покрыть тестами:

- BOM удаление
- Парсинг периода отчёта
- Извлечение тикера
- Получение курса NBP с кэшем
- Округление `money()`
- Группировка `add_dividend_to_report` / `add_tax_to_report`
- Генерация JSON
- Формирование годового PDF (минимальный smoke‑test)

---

Этот мастер‑промпт является **единственным эталонным описанием логики проекта** и должен использоваться при дальнейшем развитии.

